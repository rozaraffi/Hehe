<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Savings | Roza Mrenda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #0f172a; font-size: 13px; }
        .glass-card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; }
        .premium-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .input-premium { border: 1.5px solid #e2e8f0; transition: all 0.2s; }
        .input-premium:focus { border-color: #6366f1; outline: none; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: #0f172a; color: white; padding: 12px 24px; border-radius: 12px; margin-top: 8px; font-weight: 700; font-size: 11px; }
        .drilldown-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .drilldown-content.open { grid-template-rows: 1fr; }
        .drilldown-inner { overflow: hidden; }
        .reminder-banner { background: linear-gradient(90deg, #f0f9ff 0%, #fff1f2 100%); border: 1px solid #e2e8f0; }

        /* --- AUTO SCALING FONT SYSTEM --- */
        .auto-scale-container {
            display: flex;
            align-items: baseline;
            width: 100%;
            overflow: hidden;
        }
        
        /* Menggunakan font-size yang dinamis berdasarkan panjang karakter */
        #total-net-worth {
            font-size: clamp(1.5rem, 8vw, 3rem); /* Mengecil otomatis di layar kecil atau teks panjang */
            line-height: 1;
            white-space: nowrap;
        }

        #total-deposit, #total-all-return {
            font-size: clamp(0.9rem, 4vw, 1.125rem);
            white-space: nowrap;
            display: inline-block;
        }
    </style>
</head>
<body class="antialiased min-h-screen pb-20">

    <div id="toast-container"></div>

    <div id="content-to-export" class="max-w-5xl mx-auto pt-8 px-4 space-y-6">
        
        <header class="premium-gradient rounded-[32px] p-8 md:p-12 text-white shadow-2xl relative overflow-hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6 relative z-10">
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase">Our<span class="text-indigo-400">Savings.</span></h1>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-[0.4em] mt-1">Investment Report</p>
                </div>
                <div class="flex flex-wrap gap-2 no-print">
                    <button onclick="togglePrivacy()" class="p-3 bg-white/10 rounded-xl hover:bg-white/20 transition-all"><i data-lucide="eye" id="privacy-icon" class="w-4 h-4"></i></button>
                    <button onclick="exportJSON()" class="px-4 py-2 bg-white/10 rounded-xl text-[9px] font-black uppercase border border-white/10">Export</button>
                    <button onclick="document.getElementById('importFile').click()" class="px-4 py-2 bg-white/10 rounded-xl text-[9px] font-black uppercase border border-white/10">Import</button>
                    <input type="file" id="importFile" class="hidden" onchange="importJSON(this)">
                    <button onclick="downloadPDF()" class="px-4 py-2 bg-indigo-500 rounded-xl text-[9px] font-black uppercase shadow-lg">PDF</button>
                    <button onclick="confirmWipeAll()" class="px-4 py-2 bg-rose-600/20 text-rose-300 border border-rose-500/30 rounded-xl text-[9px] font-black uppercase hover:bg-rose-600 hover:text-white transition-all">Reset Data</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 relative z-10">
                <div class="overflow-hidden">
                    <p class="text-slate-400 font-bold mb-1 uppercase tracking-widest text-[9px]">Total Tabungan + Return</p>
                    <div class="auto-scale-container gap-4">
                        <h2 id="total-net-worth" class="font-black tracking-tighter tabular-nums">Rp 0</h2>
                        <div class="flex flex-col flex-shrink-0">
                            <span id="total-return-percent-global" class="text-emerald-400 font-black text-xs">+0%</span>
                            <span class="text-[8px] text-slate-500 uppercase font-black">ROI</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 border-t md:border-t-0 md:border-l border-white/10 pt-6 md:pt-0 md:pl-10">
                    <div class="overflow-hidden">
                        <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Total Tabungan</p>
                        <p id="total-deposit" class="font-bold text-slate-200">Rp 0</p>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Total Return</p>
                        <p class="font-bold text-emerald-400">+ <span id="total-all-return">0</span></p>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <div id="smart-reminder" class="md:col-span-7 reminder-banner rounded-[24px] p-6 flex items-center justify-between border border-slate-100">
                <div class="flex items-center gap-4">
                    <div class="bg-white p-3 rounded-2xl shadow-sm"><i data-lucide="bell-ring" class="text-indigo-600 w-5 h-5"></i></div>
                    <div>
                        <h4 id="reminder-title" class="text-[11px] font-black uppercase tracking-wider text-slate-800">Status Tabungan</h4>
                        <p id="reminder-desc" class="text-[10px] text-slate-500 font-medium italic">Mengecek data...</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-bold text-slate-400 uppercase">Target Rutin</p>
                    <p class="text-[11px] font-black text-indigo-600">Tanggal 21</p>
                </div>
            </div>
            <div class="md:col-span-5 glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-black uppercase tracking-widest">Savings Goal</h3>
                    <button onclick="openGoalModal()" class="text-[9px] font-black text-indigo-600 uppercase">Set Goal</button>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <span id="goal-target-text" class="text-[9px] font-bold text-slate-400 uppercase">Target: Rp 100jt</span>
                        <span id="goal-percent" class="text-xl font-black">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                        <div id="goal-bar" class="h-full bg-indigo-600 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <section id="input-section" class="glass-card p-6 md:p-8 no-print">
            <div class="flex gap-6 mb-8 border-b border-slate-100">
                <button onclick="setMode('save')" id="tab-save" class="pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-indigo-600 text-indigo-600">Nabung</button>
                <button onclick="setMode('transfer')" id="tab-transfer" class="pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400">Pindah Dana</button>
            </div>
            <form id="wealth-form" class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-4 space-y-4">
                    <div><label class="text-[9px] font-bold text-slate-400 uppercase">Tanggal</label><input type="date" id="in-date" required class="w-full input-premium rounded-xl p-3 text-xs font-bold"></div>
                    <div><label class="text-[9px] font-bold text-slate-400 uppercase">Nominal</label><input type="text" id="in-amount-display" required class="w-full input-premium rounded-xl p-3 text-xl font-black text-indigo-600"><p id="balance-info" class="hidden text-[10px] font-black text-rose-500 mt-2 italic"></p></div>
                    <div class="flex gap-2">
                        <button type="button" onclick="selectUser('Roza')" id="btn-user-roza" class="flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2">Roza</button>
                        <button type="button" onclick="selectUser('Mrenda')" id="btn-user-mrenda" class="flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2">Mrenda</button>
                    </div>
                </div>
                <div class="md:col-span-8 space-y-4">
                    <div id="asset-source-container"><label class="text-[9px] font-bold text-slate-400 uppercase">Pilih Instrumen</label><div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mt-1" id="asset-tiles"></div></div>
                    <div id="asset-dest-container" class="hidden"><label class="text-[9px] font-bold text-rose-500 uppercase tracking-widest">Tujuan Pindah Dana</label><div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mt-1" id="asset-tiles-dest"></div></div>
                    <input type="text" id="in-note" placeholder="Catatan transaksi..." class="w-full input-premium rounded-xl p-3 text-xs italic">
                    <div class="flex gap-2">
                        <button type="button" id="btn-cancel-edit" onclick="cancelEdit()" class="hidden flex-1 bg-slate-100 text-slate-500 font-black py-4 rounded-xl text-[10px] uppercase">Batal</button>
                        <button type="submit" id="btn-submit" class="flex-[2] bg-slate-900 text-white font-black py-4 rounded-xl text-[10px] uppercase tracking-[0.2em]">Simpan Transaksi</button>
                    </div>
                </div>
            </form>
        </section>

        <section class="glass-card p-6 cursor-pointer" onclick="toggleDrilldown()">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-[10px] font-black uppercase tracking-widest">Kontribusi</h3>
                <i data-lucide="chevron-down" id="drilldown-icon" class="w-4 h-4 text-slate-400 transition-transform"></i>
            </div>
            <div class="flex h-3 rounded-full overflow-hidden mb-3">
                <div id="bar-roza" class="bg-indigo-600 h-full transition-all" style="width: 50%"></div>
                <div id="bar-mrenda" class="bg-rose-500 h-full transition-all" style="width: 50%"></div>
            </div>
            <div class="flex justify-between text-[9px] font-black uppercase"><span class="text-indigo-600">Roza: <span id="val-roza">0</span></span><span class="text-rose-500">Mrenda: <span id="val-mrenda">0</span></span></div>
            <div id="drilldown-area" class="drilldown-content"><div class="drilldown-inner"><div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-8 border-t border-slate-50 mt-4"><div id="drilldown-roza" class="space-y-3"></div><div id="drilldown-mrenda" class="space-y-3"></div></div></div></div>
        </section>

        <section class="glass-card p-6"><h3 class="text-[10px] font-black uppercase tracking-widest mb-6">Alokasi Aset</h3><div class="relative w-full h-[300px]"><canvas id="assetChart"></canvas></div></section>

        <section class="glass-card overflow-hidden">
            <div class="p-6 border-b border-slate-50"><h3 class="text-[10px] font-black uppercase tracking-widest">Performa Aset</h3></div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[11px]">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr class="text-slate-400 text-[9px] uppercase font-black">
                            <th class="px-6 py-4">Instrumen</th>
                            <th class="px-6 py-4 text-right">Modal Pokok</th>
                            <th class="px-6 py-4 text-right">Return (IDR)</th>
                            <th class="px-6 py-4 text-center">ROI %</th>
                            <th class="px-6 py-4 text-center">Owner Mix</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="divide-y divide-slate-50 font-bold"></tbody>
                </table>
            </div>
        </section>

        <section class="space-y-4 no-print"><div class="flex justify-between items-center px-2"><h3 class="text-[10px] font-black text-slate-800 uppercase tracking-widest flex items-center gap-2"><span class="w-1.5 h-4 bg-rose-500 rounded-full"></span> Aktifitas Terakhir</h3></div><div id="transaction-history" class="grid gap-3"></div></section>
    </div>

    <div id="goal-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden px-6">
        <div class="bg-white w-full max-w-[320px] rounded-3xl p-8 shadow-2xl">
            <h3 class="text-[10px] font-black uppercase mb-4 tracking-widest text-slate-400 text-center">Set Yearly Goal</h3>
            <input type="text" id="goal-input" oninput="this.value = fmtNum(this.value)" class="w-full input-premium rounded-xl p-3 text-center font-black text-lg mb-6" placeholder="Rp 100.000.000">
            <div class="flex gap-2">
                <button onclick="closeGoalModal()" class="flex-1 py-3 rounded-xl bg-slate-100 text-[9px] font-black uppercase">Batal</button>
                <button onclick="saveGoal()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white text-[9px] font-black uppercase">Simpan</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden px-6"><div class="bg-white w-full max-w-[320px] rounded-3xl p-8 shadow-2xl text-center"><h3 id="modal-title" class="text-xs font-black uppercase mb-2 tracking-widest text-slate-400">Konfirmasi</h3><p id="modal-message" class="text-xs text-slate-600 mb-8 font-semibold"></p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-100 text-[10px] font-black uppercase">Batal</button><button id="modal-confirm-btn" class="flex-1 py-3 rounded-xl bg-rose-500 text-white text-[10px] font-black uppercase">Eksekusi</button></div></div></div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('os_v20_tx')) || [];
        let returns = JSON.parse(localStorage.getItem('os_v20_ret')) || { "Emas":0, "Reksadana":0, "Obligasi FR":0, "Saham":0, "Deposito":0 };
        let yearlyGoal = parseInt(localStorage.getItem('os_v20_goal')) || 100000000;
        const assetList = [{id:"Emas", icon:"âœ¨", color:"#fbbf24"}, {id:"Reksadana", icon:"ðŸ“ˆ", color:"#6366f1"}, {id:"Obligasi FR", icon:"ðŸ›ï¸", color:"#0f172a"}, {id:"Saham", icon:"ðŸ“Š", color:"#f43f5e"}, {id:"Deposito", icon:"ðŸ’°", color:"#10b981"}];
        let selectedUser = "Roza", selectedAsset = "Emas", selectedAssetDest = "Reksadana", editId = null, currentMode = "save", isPrivate = false, assetChart = null;

        const fmtIDR = (n) => isPrivate ? "****" : new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n);
        const fmtNum = (n) => n.toString().replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        const parseNum = (s) => parseFloat(s.toString().replace(/\./g, "")) || 0;
        function showToast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000); }

        function render() {
            let totalDepo = 0, totalRoza = 0, totalMre = 0;
            const stats = {}; assetList.forEach(a => stats[a.id] = { total: 0, roza: 0, mre: 0 });
            transactions.forEach(t => {
                totalDepo += t.amount;
                stats[t.asset].total += t.amount;
                if(t.user === 'Roza') { totalRoza += t.amount; stats[t.asset].roza += t.amount; }
                else { totalMre += t.amount; stats[t.asset].mre += t.amount; }
            });
            const totalProfit = Object.values(returns).reduce((a,b) => a+b, 0);
            const netWorth = totalDepo + totalProfit;

            // Update UI with dynamic scaling check
            const elNetWorth = document.getElementById('total-net-worth');
            elNetWorth.innerText = fmtIDR(netWorth);
            
            // Adjust font-size if text is extremely long
            if (elNetWorth.innerText.length > 15) {
                elNetWorth.style.fontSize = "clamp(1rem, 5vw, 2rem)";
            } else {
                elNetWorth.style.fontSize = ""; 
            }

            document.getElementById('total-deposit').innerText = fmtIDR(totalDepo);
            document.getElementById('total-all-return').innerText = isPrivate ? "****" : fmtNum(totalProfit);
            document.getElementById('total-return-percent-global').innerText = (totalDepo > 0 ? ((totalProfit/totalDepo)*100).toFixed(1) : 0) + "%";
            document.getElementById('goal-target-text').innerText = `Target: ${fmtIDR(yearlyGoal)}`;
            const gPct = Math.min((netWorth / yearlyGoal) * 100, 100);
            document.getElementById('goal-percent').innerText = Math.round(gPct) + "%";
            document.getElementById('goal-bar').style.width = gPct + "%";
            const pTot = totalRoza + totalMre; const pR = pTot > 0 ? (totalRoza/pTot)*100 : 50;
            document.getElementById('bar-roza').style.width = pR + "%"; document.getElementById('bar-mrenda').style.width = (100 - pR) + "%";
            document.getElementById('val-roza').innerText = fmtIDR(totalRoza); document.getElementById('val-mrenda').innerText = fmtIDR(totalMre);
            
            const tbody = document.getElementById('summary-table-body'); tbody.innerHTML = "";
            assetList.forEach(a => {
                const s = stats[a.id]; const ret = returns[a.id];
                const roi = s.total > 0 ? ((ret/s.total)*100).toFixed(1) : 0;
                const rRatio = s.total > 0 ? (s.roza/s.total)*100 : 50;
                const mRatio = 100 - rRatio;
                tbody.innerHTML += `
                    <tr>
                        <td class="px-6 py-5 uppercase flex items-center gap-2"><span>${a.icon}</span>${a.id}</td>
                        <td class="px-6 py-5 text-right text-slate-400">${fmtIDR(s.total)}</td>
                        <td class="px-6 py-5 text-right">
                            <input type="text" value="${isPrivate ? '****' : fmtNum(ret)}" 
                                onfocus="this.value=''" oninput="this.value=fmtNum(this.value)"
                                onkeydown="if(event.key==='Enter'){ returns['${a.id}']=parseNum(this.value); save(); showToast('Return ${a.id} Disimpan'); }"
                                onblur="returns['${a.id}']=parseNum(this.value); save();"
                                class="w-28 text-right bg-slate-50 p-2 rounded-lg text-emerald-600 outline-none focus:ring-2 ring-emerald-200">
                        </td>
                        <td class="px-6 py-5 text-center text-indigo-600">${roi}%</td>
                        <td class="px-6 py-4">
                            <div class="flex h-1.5 w-24 mx-auto rounded-full overflow-hidden bg-slate-100">
                                <div class="bg-indigo-500 h-full" style="width: ${rRatio}%"></div>
                                <div class="bg-rose-400 h-full" style="width: ${mRatio}%"></div>
                            </div>
                            <div class="flex justify-between text-[7px] w-24 mx-auto mt-1 uppercase text-slate-400 font-bold">
                                <span>R ${Math.round(rRatio)}%</span><span>M ${Math.round(mRatio)}%</span>
                            </div>
                        </td>
                    </tr>`;
            });

            const hDiv = document.getElementById('transaction-history'); hDiv.innerHTML = "";
            [...transactions].reverse().slice(0,10).forEach(t => {
                hDiv.innerHTML += `<div class="glass-card p-4 flex justify-between items-center border-l-4 ${t.user === 'Roza' ? 'border-l-indigo-600' : 'border-l-rose-500'}"><div class="flex gap-4 items-center"><span class="text-[8px] font-black text-slate-300 uppercase">${t.date.split('-').reverse().join('/')}</span><div><p class="text-[10px] font-black uppercase">${t.asset} | ${t.user}</p><p class="text-[9px] text-slate-400 italic">"${t.note}"</p></div></div><div class="flex items-center gap-3"><span class="text-[10px] font-black ${t.amount < 0 ? 'text-rose-500' : 'text-slate-800'}">${fmtIDR(t.amount)}</span><button onclick="editTx(${t.id})" class="p-2 text-indigo-400"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i></button><button onclick="confirmDelete(${t.id})" class="p-2 text-rose-300"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div></div>`;
            });
            updateChart(assetList.map(a => stats[a.id].total)); updateReminder(); lucide.createIcons();
        }

        // Logic lainnya dipertahankan sesuai permintaan
        function confirmWipeAll() { openModal("Reset Seluruh Data?", "Semua transaksi, profit, dan target akan dihapus permanen. Kamu tidak bisa mengembalikan data ini.", () => { transactions = []; returns = { "Emas":0, "Reksadana":0, "Obligasi FR":0, "Saham":0, "Deposito":0 }; yearlyGoal = 100000000; save(); showToast("Data Berhasil Direset!"); }); }
        function updateReminder() { const now = new Date(); const currM = now.getMonth(); const currY = now.getFullYear(); const rDone = transactions.some(t => t.user === 'Roza' && t.amount > 0 && new Date(t.date).getMonth() === currM && new Date(t.date).getFullYear() === currY); const mDone = transactions.some(t => t.user === 'Mrenda' && t.amount > 0 && new Date(t.date).getMonth() === currM && new Date(t.date).getFullYear() === currY); const title = document.getElementById('reminder-title'); const desc = document.getElementById('reminder-desc'); const banner = document.getElementById('smart-reminder'); if (rDone && mDone) { title.innerText = "Goal Tercapai! ðŸŽ¯"; desc.innerText = "Keduanya sudah menabung bulan ini."; banner.style.background = "linear-gradient(90deg, #f0fdf4 0%, #ecfdf5 100%)"; } else if (rDone) { title.innerText = "Giliran Mrenda! ðŸš€"; desc.innerText = "Roza sudah setor."; banner.style.background = ""; } else if (mDone) { title.innerText = "Giliran Roza! ðŸš€"; desc.innerText = "Mrenda sudah setor."; banner.style.background = ""; } else { title.innerText = "Belum Ada Setoran ðŸ“…"; desc.innerText = "Ayo menabung bersama setiap tanggal 21!"; banner.style.background = ""; } }
        function setMode(mode) { currentMode = mode; document.getElementById('tab-save').className = mode === 'save' ? 'pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-indigo-600 text-indigo-600' : 'pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400'; document.getElementById('tab-transfer').className = mode === 'transfer' ? 'pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-rose-500 text-rose-500' : 'pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400'; document.getElementById('asset-dest-container').classList.toggle('hidden', mode === 'save'); document.getElementById('btn-submit').innerText = mode === 'save' ? 'Simpan Transaksi' : 'Eksekusi Pindah Dana'; updateBalanceInfo(); if(mode === 'transfer') initTilesDest(); }
        function updateBalanceInfo() { const info = document.getElementById('balance-info'); if(currentMode === 'transfer') { const bal = transactions.filter(t => t.user === selectedUser && t.asset === selectedAsset).reduce((a,b) => a + b.amount, 0); info.innerText = `Saldo ${selectedAsset}: ${fmtIDR(bal)}`; info.classList.remove('hidden'); } else info.classList.add('hidden'); }
        function selectUser(u) { selectedUser = u; document.getElementById('btn-user-roza').className = u === 'Roza' ? 'flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2 border-indigo-600 bg-indigo-50 text-indigo-600' : 'flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2 border-slate-100 text-slate-400'; document.getElementById('btn-user-mrenda').className = u === 'Mrenda' ? 'flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2 border-rose-500 bg-rose-50 text-rose-500' : 'flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2 border-slate-100 text-slate-400'; updateBalanceInfo(); }
        function initTiles() { const container = document.getElementById('asset-tiles'); container.innerHTML = ""; assetList.forEach(a => { const btn = document.createElement('button'); btn.type = "button"; btn.className = `p-3 rounded-xl border-2 flex flex-col items-center gap-1 font-black text-[8px] uppercase transition-all ${selectedAsset === a.id ? 'border-indigo-600 bg-indigo-50 text-indigo-600' : 'border-slate-50 text-slate-400'}`; btn.innerHTML = `<span class="text-lg">${a.icon}</span>${a.id}`; btn.onclick = () => { selectedAsset = a.id; initTiles(); updateBalanceInfo(); if(currentMode === 'transfer') initTilesDest(); }; container.appendChild(btn); }); }
        function initTilesDest() { const container = document.getElementById('asset-tiles-dest'); container.innerHTML = ""; assetList.forEach(a => { const isSource = a.id === selectedAsset; const btn = document.createElement('button'); btn.type = "button"; btn.className = `p-3 rounded-xl border-2 flex flex-col items-center gap-1 font-black text-[8px] uppercase ${isSource ? 'opacity-20 cursor-not-allowed border-slate-50' : (selectedAssetDest === a.id ? 'border-rose-500 bg-rose-50 text-rose-500' : 'border-slate-50 text-slate-400')}`; btn.innerHTML = `<span class="text-lg">${a.icon}</span>${a.id}`; if(!isSource) btn.onclick = () => { selectedAssetDest = a.id; initTilesDest(); }; container.appendChild(btn); }); }
        function toggleDrilldown() { const content = document.getElementById('drilldown-area'); const icon = document.getElementById('drilldown-icon'); content.classList.toggle('open'); icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; if(content.classList.contains('open')) renderDrilldown(); }
        function renderDrilldown() { const rDiv = document.getElementById('drilldown-roza'); const mDiv = document.getElementById('drilldown-mrenda'); const draw = (user, colorClass) => { let total = 0; const aData = {}; assetList.forEach(a => aData[a.id] = 0); transactions.filter(t => t.user === user).forEach(t => { total += t.amount; aData[t.asset] += t.amount; }); let html = `<p class="text-[10px] font-black uppercase mb-4 text-slate-800 flex items-center gap-2"><span class="w-2 h-2 rounded-full ${colorClass}"></span>${user} Portfolio</p>`; assetList.forEach(a => { const val = aData[a.id]; const pct = total > 0 ? (val/total)*100 : 0; if(val > 0) { html += `<div class="mb-4"><div class="flex justify-between text-[8px] font-bold uppercase mb-1"><span class="text-slate-700">${a.id}</span><span class="text-slate-400">${fmtIDR(val)} (${Math.round(pct)}%)</span></div><div class="w-full bg-slate-100 h-1 rounded-full"><div class="${colorClass} h-full" style="width:${pct}%"></div></div></div>`; } }); return html; }; rDiv.innerHTML = draw('Roza', 'bg-indigo-600'); mDiv.innerHTML = draw('Mrenda', 'bg-rose-500'); }
        function updateChart(data) { const ctx = document.getElementById('assetChart').getContext('2d'); if(assetChart) assetChart.destroy(); assetChart = new Chart(ctx, { type: 'doughnut', data: { labels: assetList.map(a => a.id), datasets: [{ data, backgroundColor: assetList.map(a => a.color), borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, layout: { padding: 10 }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10, weight: 'bold' } } } } } }); }
        document.getElementById('wealth-form').onsubmit = (e) => { e.preventDefault(); const amt = parseNum(document.getElementById('in-amount-display').value); const date = document.getElementById('in-date').value; const note = document.getElementById('in-note').value || '-'; if(currentMode === 'transfer') { const bal = transactions.filter(t => t.user === selectedUser && t.asset === selectedAsset).reduce((a,b) => a + b.amount, 0); if(amt > bal) return showToast("Saldo tidak cukup!"); const tid = Date.now(); transactions.push({ id: tid, date, user: selectedUser, asset: selectedAsset, amount: -amt, note: `[Pindah] Ke ${selectedAssetDest}: ${note}` }); transactions.push({ id: tid+1, date, user: selectedUser, asset: selectedAssetDest, amount: amt, note: `[Pindah] Dari ${selectedAsset}: ${note}` }); } else { if(editId) { const idx = transactions.findIndex(t => t.id === editId); transactions[idx] = { id: editId, date, user: selectedUser, asset: selectedAsset, amount: amt, note }; editId = null; } else transactions.push({ id: Date.now(), date, user: selectedUser, asset: selectedAsset, amount: amt, note }); } save(); cancelEdit(); showToast("Berhasil!"); };
        function editTx(id) { const t = transactions.find(x => x.id === id); editId = id; setMode('save'); selectUser(t.user); selectedAsset = t.asset; initTiles(); document.getElementById('in-date').value = t.date; document.getElementById('in-amount-display').value = fmtNum(t.amount); document.getElementById('in-note').value = t.note; document.getElementById('btn-submit').innerText = "Update"; document.getElementById('btn-cancel-edit').classList.remove('hidden'); document.getElementById('input-section').scrollIntoView({ behavior: 'smooth' }); }
        function cancelEdit() { editId = null; document.getElementById('wealth-form').reset(); document.getElementById('in-date').valueAsDate = new Date(); document.getElementById('btn-submit').innerText = "Simpan Transaksi"; document.getElementById('btn-cancel-edit').classList.add('hidden'); setMode('save'); }
        function togglePrivacy() { isPrivate = !isPrivate; render(); }
        
        // MODIFIED: Formatting yearly goal input
        function openGoalModal() { 
            document.getElementById('goal-modal').classList.remove('hidden'); 
            document.getElementById('goal-input').value = fmtNum(yearlyGoal); 
        }
        function closeGoalModal() { document.getElementById('goal-modal').classList.add('hidden'); }
        function saveGoal() { yearlyGoal = parseNum(document.getElementById('goal-input').value); localStorage.setItem('os_v20_goal', yearlyGoal); render(); closeGoalModal(); }
        
        function save() { localStorage.setItem('os_v20_tx', JSON.stringify(transactions)); localStorage.setItem('os_v20_ret', JSON.stringify(returns)); render(); }
        function exportJSON() { const blob = new Blob([JSON.stringify({ transactions, returns, yearlyGoal })], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup.json`; a.click(); }
        function importJSON(i) { const r = new FileReader(); r.onload = (e) => { const d = JSON.parse(e.target.result); transactions = d.transactions || []; returns = d.returns || { "Emas":0, "Reksadana":0, "Obligasi FR":0, "Saham":0, "Deposito":0 }; yearlyGoal = d.yearlyGoal || 100000000; save(); }; r.readAsText(i.files[0]); }
        async function downloadPDF() { const opt = { margin: 10, filename: 'Report.pdf', html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } }; html2pdf().set(opt).from(document.getElementById('content-to-export')).save(); }
        function confirmDelete(id) { openModal("Hapus?", "Yakin hapus data?", () => { transactions = transactions.filter(t => t.id !== id); save(); }); }
        function openModal(t, m, c) { document.getElementById('modal-title').innerText=t; document.getElementById('modal-message').innerText=m; document.getElementById('custom-modal').classList.remove('hidden'); pendingAction=c; }
        function closeModal() { document.getElementById('custom-modal').classList.add('hidden'); }
        document.getElementById('modal-confirm-btn').onclick = () => { if(pendingAction) pendingAction(); closeModal(); };
        document.getElementById('in-amount-display').oninput = (e) => e.target.value = fmtNum(e.target.value);
        window.onload = () => { initTiles(); selectUser('Roza'); document.getElementById('in-date').valueAsDate = new Date(); render(); };
    </script>
</body>
</html>
