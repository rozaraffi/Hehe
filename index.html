<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Savings | Roza Mrenda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --bg-main: #f8fafc; --card-bg: #ffffff; --text-main: #0f172a; --border-color: #e2e8f0; }
        .dark-mode { --bg-main: #020617; --card-bg: #0f172a; --text-main: #f1f5f9; --border-color: #1e293b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-main); color: var(--text-main); font-size: 13px; transition: all 0.4s ease; }
        .glass-card { background: var(--card-bg); border-radius: 24px; border: 1px solid var(--border-color); transition: transform 0.3s ease; }
        .glass-card:hover { transform: translateY(-3px); }
        .premium-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .input-premium { border: 1.5px solid var(--border-color); background: var(--card-bg); color: var(--text-main); transition: all 0.2s; }
        .input-premium:focus { border-color: #6366f1; outline: none; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: #0f172a; color: white; padding: 12px 24px; border-radius: 12px; margin-top: 8px; font-weight: 700; font-size: 11px; }
        .drilldown-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .drilldown-content.open { grid-template-rows: 1fr; }
        .drilldown-inner { overflow: hidden; }
        .reminder-banner { border: 1px solid var(--border-color); background: linear-gradient(90deg, #f0f9ff 0%, #fff1f2 100%); }
        .dark-mode .reminder-banner { background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%); }
        .auto-scale-container { display: flex; align-items: baseline; width: 100%; overflow: hidden; }
        #total-net-worth { font-size: clamp(1.5rem, 8vw, 3rem); line-height: 1; white-space: nowrap; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        section, header { animation: fadeInUp 0.6s ease-out forwards; }
    </style>
</head>
<body class="antialiased min-h-screen pb-20">
    <div id="toast-container"></div>
    <div id="content-to-export" class="max-w-5xl mx-auto pt-8 px-4 space-y-6">
        <header class="premium-gradient rounded-[32px] p-8 md:p-12 text-white shadow-2xl relative overflow-hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6 relative z-10">
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase">Our<span class="text-indigo-400">Savings.</span></h1>
                    <div id="milestone-badge" class="mt-2 inline-block px-3 py-1 bg-white/10 rounded-full text-[8px] font-black tracking-widest uppercase border border-white/10">üê£ Starter Wealth</div>
                </div>
                <div class="flex flex-wrap gap-2 no-print">
                    <button onclick="toggleDarkMode()" class="p-3 bg-white/10 rounded-xl hover:bg-white/20 transition-all"><i data-lucide="moon" id="dark-icon" class="w-4 h-4"></i></button>
                    <button onclick="togglePrivacy()" class="p-3 bg-white/10 rounded-xl hover:bg-white/20 transition-all"><i data-lucide="eye" id="privacy-icon" class="w-4 h-4"></i></button>
                    <button onclick="exportJSON()" class="px-4 py-2 bg-white/10 rounded-xl text-[9px] font-black uppercase border border-white/10">Export</button>
                    <button onclick="document.getElementById('importFile').click()" class="px-4 py-2 bg-white/10 rounded-xl text-[9px] font-black uppercase border border-white/10">Import</button>
                    <input type="file" id="importFile" class="hidden" onchange="importJSON(this)">
                    <button onclick="downloadPDF()" class="px-4 py-2 bg-indigo-500 rounded-xl text-[9px] font-black uppercase shadow-lg">PDF</button>
                    <button onclick="confirmWipeAll()" class="px-4 py-2 bg-rose-600/20 text-rose-300 border border-rose-500/30 rounded-xl text-[9px] font-black uppercase hover:bg-rose-600 hover:text-white transition-all">Reset Data</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 relative z-10">
                <div>
                    <p class="text-slate-400 font-bold mb-1 uppercase tracking-widest text-[9px]">Total Tabungan + Return</p>
                    <div class="auto-scale-container gap-4">
                        <h2 id="total-net-worth" class="font-black tracking-tighter tabular-nums">Rp 0</h2>
                        <div class="flex flex-col flex-shrink-0">
                            <span id="total-return-percent-global" class="text-emerald-400 font-black text-xs">+0%</span>
                            <span class="text-[8px] text-slate-500 uppercase font-black">ROI</span>
                        </div>
                    </div>
                    <p id="growth-info" class="text-[9px] text-indigo-300 font-bold mt-2 uppercase tracking-tight"></p>
                </div>
                <div class="grid grid-cols-2 gap-4 border-t md:border-t-0 md:border-l border-white/10 pt-6 md:pt-0 md:pl-10">
                    <div>
                        <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Total Tabungan</p>
                        <p id="total-deposit" class="font-bold text-slate-200">Rp 0</p>
                    </div>
                    <div>
                        <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Total Return</p>
                        <p class="font-bold text-emerald-400">+ <span id="total-all-return">0</span></p>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <div id="smart-reminder" class="md:col-span-7 reminder-banner rounded-[24px] p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm"><i data-lucide="bell-ring" class="text-indigo-600 w-5 h-5"></i></div>
                    <div>
                        <h4 id="reminder-title" class="text-[11px] font-black uppercase tracking-wider">Status Tabungan</h4>
                        <p id="reminder-desc" class="text-[10px] text-slate-500 font-medium italic">Mengecek data...</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-bold text-slate-400 uppercase">Target Rutin</p>
                    <p class="text-[11px] font-black text-indigo-600">Tanggal 21</p>
                </div>
            </div>
            <div class="md:col-span-5 glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-black uppercase tracking-widest">Savings Goal</h3>
                    <button onclick="openGoalModal()" class="text-[9px] font-black text-indigo-600 uppercase">Set Goal</button>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <span id="goal-target-text" class="text-[9px] font-bold text-slate-400 uppercase">Target: Rp 100jt</span>
                        <span id="goal-percent" class="text-xl font-black">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 dark:bg-slate-800 h-2.5 rounded-full overflow-hidden"><div id="goal-bar" class="h-full bg-indigo-600 transition-all duration-1000" style="width: 0%"></div></div>
                    <p id="reward-text" class="text-[9px] text-rose-500 font-black uppercase italic tracking-tighter"></p>
                </div>
            </div>
        </div>

        <section id="input-section" class="glass-card p-6 md:p-8 no-print">
            <div class="flex gap-6 mb-8 border-b border-slate-100 dark:border-slate-800">
                <button onclick="setMode('save')" id="tab-save" class="pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-indigo-600 text-indigo-600">Nabung</button>
                <button onclick="setMode('transfer')" id="tab-transfer" class="pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400">Pindah Dana</button>
            </div>
            <form id="wealth-form" class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-4 space-y-4">
                    <div><label class="text-[9px] font-bold text-slate-400 uppercase">Tanggal</label><input type="date" id="in-date" required class="w-full input-premium rounded-xl p-3 text-xs font-bold"></div>
                    <div><label class="text-[9px] font-bold text-slate-400 uppercase">Nominal</label><input type="text" id="in-amount-display" required class="w-full input-premium rounded-xl p-3 text-xl font-black text-indigo-600"><p id="balance-info" class="hidden text-[10px] font-black text-rose-500 mt-2 italic"></p></div>
                    <div class="flex gap-2">
                        <button type="button" onclick="selectUser('Roza')" id="btn-user-roza" class="flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2">Roza</button>
                        <button type="button" onclick="selectUser('Mrenda')" id="btn-user-mrenda" class="flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2">Mrenda</button>
                    </div>
                </div>
                <div class="md:col-span-8 space-y-4">
                    <div id="asset-source-container"><label class="text-[9px] font-bold text-slate-400 uppercase">Pilih Instrumen</label><div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mt-1" id="asset-tiles"></div></div>
                    <div id="asset-dest-container" class="hidden"><label class="text-[9px] font-bold text-rose-500 uppercase tracking-widest">Tujuan Pindah Dana</label><div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mt-1" id="asset-tiles-dest"></div></div>
                    <input type="text" id="in-note" placeholder="Catatan transaksi..." class="w-full input-premium rounded-xl p-3 text-xs italic">
                    <div class="flex gap-2">
                        <button type="button" id="btn-cancel-edit" onclick="cancelEdit()" class="hidden flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-black py-4 rounded-xl text-[10px] uppercase">Batal</button>
                        <button type="submit" id="btn-submit" class="flex-[2] bg-slate-900 dark:bg-indigo-600 text-white font-black py-4 rounded-xl text-[10px] uppercase tracking-[0.2em]">Simpan Transaksi</button>
                    </div>
                </div>
            </form>
        </section>

        <section class="glass-card p-6 cursor-pointer" onclick="toggleDrilldown()">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-[10px] font-black uppercase tracking-widest">Kontribusi</h3>
                <i data-lucide="chevron-down" id="drilldown-icon" class="w-4 h-4 text-slate-400 transition-transform"></i>
            </div>
            <div class="flex h-3 rounded-full overflow-hidden mb-3 bg-slate-100 dark:bg-slate-800">
                <div id="bar-roza" class="bg-indigo-600 h-full transition-all" style="width: 50%"></div>
                <div id="bar-mrenda" class="bg-rose-500 h-full transition-all" style="width: 50%"></div>
            </div>
            <div class="flex justify-between text-[9px] font-black uppercase"><span class="text-indigo-600">Roza: <span id="val-roza">0</span></span><span class="text-rose-500">Mrenda: <span id="val-mrenda">0</span></span></div>
            <div id="drilldown-area" class="drilldown-content"><div class="drilldown-inner"><div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-8 border-t border-slate-50 dark:border-slate-800 mt-4"><div id="drilldown-roza" class="space-y-3"></div><div id="drilldown-mrenda" class="space-y-3"></div></div></div></div>
        </section>

        <section class="glass-card p-6"><h3 class="text-[10px] font-black uppercase tracking-widest mb-6">Alokasi Aset</h3><div class="relative w-full h-[300px]"><canvas id="assetChart"></canvas></div></section>

        <section class="glass-card overflow-hidden">
            <div class="p-6 border-b border-slate-50 dark:border-slate-800"><h3 class="text-[10px] font-black uppercase tracking-widest">Performa Aset</h3></div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[11px]">
                    <thead class="bg-slate-50 dark:bg-slate-900 border-b border-slate-100 dark:border-slate-800">
                        <tr class="text-slate-400 text-[9px] uppercase font-black">
                            <th class="px-6 py-4">Instrumen</th>
                            <th class="px-6 py-4 text-right">Modal Pokok</th>
                            <th class="px-6 py-4 text-right">Return (IDR)</th>
                            <th class="px-6 py-4 text-center">ROI %</th>
                            <th class="px-6 py-4 text-center">Owner Mix</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="divide-y divide-slate-50 dark:divide-slate-800 font-bold"></tbody>
                </table>
            </div>
        </section>

        <section class="space-y-4 no-print"><div class="flex justify-between items-center px-2"><h3 class="text-[10px] font-black uppercase tracking-widest flex items-center gap-2"><span class="w-1.5 h-4 bg-rose-500 rounded-full"></span> Aktifitas Terakhir</h3></div><div id="transaction-history" class="grid gap-3"></div></section>
    </div>

    <div id="goal-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden px-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-[340px] rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-[10px] font-black uppercase mb-4 tracking-widest text-slate-400 text-center">Custom Goal & Milestones</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[8px] font-black uppercase text-slate-400">Total Savings Goal (Rp)</label>
                    <input type="text" id="goal-input" oninput="this.value = fmtNum(this.value)" class="w-full input-premium rounded-xl p-2.5 text-center font-black text-base">
                </div>
                
                <div class="grid grid-cols-1 gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-2xl">
                    <p class="text-[8px] font-black uppercase text-center text-indigo-500 mb-1">Set Milestone Thresholds (Rp)</p>
                    <div>
                        <label class="text-[7px] font-black uppercase text-slate-400">Foundation (üê£ -> üß±)</label>
                        <input type="text" id="ms-foundation" oninput="this.value = fmtNum(this.value)" class="w-full bg-transparent border-b border-slate-200 dark:border-slate-700 p-1 text-xs font-bold text-center">
                    </div>
                    <div>
                        <label class="text-[7px] font-black uppercase text-slate-400">Silver Saver (üß± -> ü•à)</label>
                        <input type="text" id="ms-silver" oninput="this.value = fmtNum(this.value)" class="w-full bg-transparent border-b border-slate-200 dark:border-slate-700 p-1 text-xs font-bold text-center">
                    </div>
                    <div>
                        <label class="text-[7px] font-black uppercase text-slate-400">Saving Legend (ü•à -> üèÜ)</label>
                        <input type="text" id="ms-legend" oninput="this.value = fmtNum(this.value)" class="w-full bg-transparent border-b border-slate-200 dark:border-slate-700 p-1 text-xs font-bold text-center">
                    </div>
                </div>

                <div>
                    <label class="text-[8px] font-black uppercase text-slate-400">Self Reward Jika Tercapai</label>
                    <input type="text" id="reward-input" class="w-full input-premium rounded-xl p-2.5 text-center font-bold text-xs" placeholder="Misal: Staycation">
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="closeGoalModal()" class="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-300 text-[9px] font-black uppercase">Batal</button>
                <button onclick="saveGoal()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white text-[9px] font-black uppercase">Simpan</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden px-6"><div class="bg-white dark:bg-slate-900 w-full max-w-[320px] rounded-3xl p-8 shadow-2xl text-center"><h3 id="modal-title" class="text-xs font-black uppercase mb-2 tracking-widest text-slate-400">Konfirmasi</h3><p id="modal-message" class="text-xs text-slate-600 mb-8 font-semibold"></p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500 text-[10px] font-black uppercase">Batal</button><button id="modal-confirm-btn" class="flex-1 py-3 rounded-xl bg-rose-500 text-white text-[10px] font-black uppercase">Eksekusi</button></div></div></div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('os_v20_tx')) || [];
        let returns = JSON.parse(localStorage.getItem('os_v20_ret')) || { "Emas":0, "Reksadana":0, "Obligasi FR":0, "Saham":0, "Deposito":0 };
        
        // Milestone Control Storage
        let yearlyGoal = parseInt(localStorage.getItem('os_v20_goal')) || 100000000;
        let selfReward = localStorage.getItem('os_v20_reward') || "";
        let msThresholds = JSON.parse(localStorage.getItem('os_v20_ms')) || { foundation: 10000000, silver: 50000000, legend: 100000000 };

        const assetList = [{id:"Emas", icon:"‚ú®", color:"#fbbf24"}, {id:"Reksadana", icon:"üìà", color:"#6366f1"}, {id:"Obligasi FR", icon:"üèõÔ∏è", color:"#0f172a"}, {id:"Saham", icon:"üìä", color:"#f43f5e"}, {id:"Deposito", icon:"üí∞", color:"#10b981"}];
        let selectedUser = "Roza", selectedAsset = "Emas", selectedAssetDest = "Reksadana", editId = null, currentMode = "save", isPrivate = false, assetChart = null;

        const fmtIDR = (n) => isPrivate ? "****" : new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n);
        const fmtNum = (n) => n.toString().replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        const parseNum = (s) => parseFloat(s.toString().replace(/\./g, "")) || 0;
        function showToast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000); }

        function render() {
            let totalDepo = 0, totalRoza = 0, totalMre = 0;
            const stats = {}; assetList.forEach(a => stats[a.id] = { total: 0, roza: 0, mre: 0 });
            const now = new Date(); const currM = now.getMonth(); const currY = now.getFullYear();
            let savedThisMonth = 0, savedLastMonth = 0;

            transactions.forEach(t => {
                totalDepo += t.amount;
                stats[t.asset].total += t.amount;
                if(t.user === 'Roza') { totalRoza += t.amount; stats[t.asset].roza += t.amount; }
                else { totalMre += t.amount; stats[t.asset].mre += t.amount; }
                const tDate = new Date(t.date);
                if(tDate.getMonth() === currM && tDate.getFullYear() === currY) savedThisMonth += t.amount;
                if(tDate.getMonth() === (currM-1 < 0 ? 11 : currM-1) && tDate.getFullYear() === (currM-1 < 0 ? currY-1 : currY)) savedLastMonth += t.amount;
            });

            const totalProfit = Object.values(returns).reduce((a,b) => a+b, 0);
            const netWorth = totalDepo + totalProfit;
            const totalRoiPercent = totalDepo > 0 ? ((totalProfit/totalDepo)*100).toFixed(1) : 0;

            if (!isPrivate) {
                animateValue('total-net-worth', 0, netWorth, 1000, true);
                animateValue('total-deposit', 0, totalDepo, 1000, true);
                animateValue('total-all-return', 0, totalProfit, 1000, false);
                animateValue('total-return-percent-global', 0, totalRoiPercent, 1000, false, true);
            } else {
                ['total-net-worth','total-deposit','total-all-return','total-return-percent-global'].forEach(id => document.getElementById(id).innerText = id.includes('percent') ? "****%" : "****");
            }

            updateMilestone(netWorth);
            const growthInfo = document.getElementById('growth-info');
            if (savedLastMonth > 0) {
                const diff = ((savedThisMonth - savedLastMonth) / savedLastMonth * 100).toFixed(0);
                growthInfo.innerText = diff >= 0 ? `üìà Naik ${diff}% dari bulan lalu` : `üìâ Turun ${Math.abs(diff)}% dari bulan lalu`;
            }

            document.getElementById('goal-target-text').innerText = `Target: ${fmtIDR(yearlyGoal)}`;
            const gPct = Math.min((netWorth / yearlyGoal) * 100, 100);
            document.getElementById('goal-percent').innerText = Math.round(gPct) + "%";
            document.getElementById('goal-bar').style.width = gPct + "%";
            document.getElementById('reward-text').innerText = selfReward ? `üéÅ Reward: ${selfReward}` : "";

            const pTot = totalRoza + totalMre; const pR = pTot > 0 ? (totalRoza/pTot)*100 : 50;
            document.getElementById('bar-roza').style.width = pR + "%"; document.getElementById('bar-mrenda').style.width = (100 - pR) + "%";
            document.getElementById('val-roza').innerText = fmtIDR(totalRoza); document.getElementById('val-mrenda').innerText = fmtIDR(totalMre);
            
            const tbody = document.getElementById('summary-table-body'); tbody.innerHTML = "";
            assetList.forEach(a => {
                const s = stats[a.id]; const ret = returns[a.id];
                const roi = s.total > 0 ? ((ret/s.total)*100).toFixed(1) : 0;
                const rRatio = s.total > 0 ? (s.roza/s.total)*100 : 50;
                tbody.innerHTML += `<tr><td class="px-6 py-5 uppercase flex items-center gap-2"><span>${a.icon}</span>${a.id}</td><td class="px-6 py-5 text-right text-slate-400">${fmtIDR(s.total)}</td><td class="px-6 py-5 text-right"><input type="text" value="${isPrivate ? '****' : fmtNum(ret)}" onfocus="this.value=''" oninput="this.value=fmtNum(this.value)" onkeydown="if(event.key==='Enter'){ returns['${a.id}']=parseNum(this.value); save(); }" onblur="returns['${a.id}']=parseNum(this.value); save();" class="w-28 text-right bg-slate-50 dark:bg-slate-800 p-2 rounded-lg text-emerald-600 outline-none"></td><td class="px-6 py-5 text-center text-indigo-600">${roi}%</td><td class="px-6 py-4"><div class="flex h-1.5 w-24 mx-auto rounded-full overflow-hidden bg-slate-100 dark:bg-slate-800"><div class="bg-indigo-500 h-full" style="width: ${rRatio}%"></div><div class="bg-rose-400 h-full" style="width: ${100-rRatio}%"></div></div></td></tr>`;
            });

            const hDiv = document.getElementById('transaction-history'); hDiv.innerHTML = "";
            [...transactions].reverse().slice(0,10).forEach(t => {
                hDiv.innerHTML += `<div class="glass-card p-4 flex justify-between items-center border-l-4 ${t.user === 'Roza' ? 'border-l-indigo-600' : 'border-l-rose-500'}"><div class="flex gap-4 items-center"><span class="text-[8px] font-black text-slate-300 uppercase">${t.date.split('-').reverse().join('/')}</span><div><p class="text-[10px] font-black uppercase">${t.asset} | ${t.user}</p><p class="text-[9px] text-slate-400 italic">"${t.note}"</p></div></div><div class="flex items-center gap-3"><span class="text-[10px] font-black ${t.amount < 0 ? 'text-rose-500' : 'text-slate-800 dark:text-slate-200'}">${fmtIDR(t.amount)}</span><button onclick="editTx(${t.id})" class="p-2 text-indigo-400"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i></button><button onclick="confirmDelete(${t.id})" class="p-2 text-rose-300"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div></div>`;
            });
            updateChart(assetList.map(a => stats[a.id].total)); updateReminder(); lucide.createIcons();
        }

        function animateValue(id, start, end, duration, isIdr = false, isPercent = false) {
            const obj = document.getElementById(id); if (!obj || isPrivate) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = progress * (end - start) + start;
                if (isIdr) obj.innerText = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(Math.floor(current));
                else if (isPercent) obj.innerText = "+" + current.toFixed(1) + "%";
                else obj.innerText = Math.floor(current).toLocaleString('id-ID');
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function updateMilestone(val) {
            const m = document.getElementById('milestone-badge');
            if (val >= msThresholds.legend) m.innerHTML = "üèÜ Saving Legend";
            else if (val >= msThresholds.silver) m.innerHTML = "ü•à Silver Saver";
            else if (val >= msThresholds.foundation) m.innerHTML = "üß± Solid Foundation";
            else m.innerHTML = "üê£ Starter Wealth";
        }

        function openGoalModal() { 
            document.getElementById('goal-modal').classList.remove('hidden'); 
            document.getElementById('goal-input').value = fmtNum(yearlyGoal); 
            document.getElementById('reward-input').value = selfReward;
            document.getElementById('ms-foundation').value = fmtNum(msThresholds.foundation);
            document.getElementById('ms-silver').value = fmtNum(msThresholds.silver);
            document.getElementById('ms-legend').value = fmtNum(msThresholds.legend);
        }
        function closeGoalModal() { document.getElementById('goal-modal').classList.add('hidden'); }
        function saveGoal() { 
            yearlyGoal = parseNum(document.getElementById('goal-input').value); 
            selfReward = document.getElementById('reward-input').value;
            msThresholds = {
                foundation: parseNum(document.getElementById('ms-foundation').value),
                silver: parseNum(document.getElementById('ms-silver').value),
                legend: parseNum(document.getElementById('ms-legend').value)
            };
            localStorage.setItem('os_v20_goal', yearlyGoal); 
            localStorage.setItem('os_v20_reward', selfReward);
            localStorage.setItem('os_v20_ms', JSON.stringify(msThresholds));
            render(); closeGoalModal(); showToast("Pengaturan Disimpan!");
        }

        // --- Fungsi Dasar (Sama seperti sebelumnya) ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('dark-icon').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            lucide.createIcons();
            localStorage.setItem('os_theme', isDark ? 'dark' : 'light');
        }
        function save() { localStorage.setItem('os_v20_tx', JSON.stringify(transactions)); localStorage.setItem('os_v20_ret', JSON.stringify(returns)); render(); }
        function selectUser(u) { selectedUser = u; document.getElementById('btn-user-roza').className = u === 'Roza' ? 'flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2 border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600' : 'flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2 border-slate-100 dark:border-slate-800 text-slate-400'; document.getElementById('btn-user-mrenda').className = u === 'Mrenda' ? 'flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2 border-rose-500 bg-rose-50 dark:bg-rose-900/20 text-rose-500' : 'flex-1 py-3 rounded-xl font-black text-[9px] uppercase border-2 border-slate-100 dark:border-slate-800 text-slate-400'; updateBalanceInfo(); }
        function initTiles() { const container = document.getElementById('asset-tiles'); container.innerHTML = ""; assetList.forEach(a => { const btn = document.createElement('button'); btn.type = "button"; btn.className = `p-3 rounded-xl border-2 flex flex-col items-center gap-1 font-black text-[8px] uppercase transition-all ${selectedAsset === a.id ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600' : 'border-slate-50 dark:border-slate-800 text-slate-400'}`; btn.innerHTML = `<span class="text-lg">${a.icon}</span>${a.id}`; btn.onclick = () => { selectedAsset = a.id; initTiles(); updateBalanceInfo(); if(currentMode === 'transfer') initTilesDest(); }; container.appendChild(btn); }); }
        function initTilesDest() { const container = document.getElementById('asset-tiles-dest'); container.innerHTML = ""; assetList.forEach(a => { const isSource = a.id === selectedAsset; const btn = document.createElement('button'); btn.type = "button"; btn.className = `p-3 rounded-xl border-2 flex flex-col items-center gap-1 font-black text-[8px] uppercase ${isSource ? 'opacity-20 cursor-not-allowed border-slate-50' : (selectedAssetDest === a.id ? 'border-rose-500 bg-rose-50 dark:bg-rose-900/20 text-rose-500' : 'border-slate-50 dark:border-slate-800 text-slate-400')}`; btn.innerHTML = `<span class="text-lg">${a.icon}</span>${a.id}`; if(!isSource) btn.onclick = () => { selectedAssetDest = a.id; initTilesDest(); }; container.appendChild(btn); }); }
        function setMode(mode) { currentMode = mode; document.getElementById('tab-save').className = mode === 'save' ? 'pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-indigo-600 text-indigo-600' : 'pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400'; document.getElementById('tab-transfer').className = mode === 'transfer' ? 'pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-rose-500 text-rose-500' : 'pb-3 text-[10px] font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400'; document.getElementById('asset-dest-container').classList.toggle('hidden', mode === 'save'); document.getElementById('btn-submit').innerText = mode === 'save' ? 'Simpan Transaksi' : 'Eksekusi Pindah Dana'; updateBalanceInfo(); if(mode === 'transfer') initTilesDest(); }
        function updateBalanceInfo() { const info = document.getElementById('balance-info'); if(currentMode === 'transfer') { const bal = transactions.filter(t => t.user === selectedUser && t.asset === selectedAsset).reduce((a,b) => a + b.amount, 0); info.innerText = `Saldo ${selectedAsset}: ${fmtIDR(bal)}`; info.classList.remove('hidden'); } else info.classList.add('hidden'); }
        function updateReminder() { const now = new Date(); const currM = now.getMonth(); const currY = now.getFullYear(); const rDone = transactions.some(t => t.user === 'Roza' && t.amount > 0 && new Date(t.date).getMonth() === currM && new Date(t.date).getFullYear() === currY); const mDone = transactions.some(t => t.user === 'Mrenda' && t.amount > 0 && new Date(t.date).getMonth() === currM && new Date(t.date).getFullYear() === currY); const title = document.getElementById('reminder-title'); const desc = document.getElementById('reminder-desc'); if (rDone && mDone) { title.innerText = "Goal Tercapai! üéØ"; desc.innerText = "Keduanya sudah menabung bulan ini."; } else if (rDone) { title.innerText = "Giliran Mrenda! üöÄ"; desc.innerText = "Roza sudah setor."; } else if (mDone) { title.innerText = "Giliran Roza! üöÄ"; desc.innerText = "Mrenda sudah setor."; } else { title.innerText = "Belum Ada Setoran üìÖ"; desc.innerText = "Ayo menabung bersama setiap tanggal 21!"; } }
        function toggleDrilldown() { const content = document.getElementById('drilldown-area'); const icon = document.getElementById('drilldown-icon'); content.classList.toggle('open'); icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; if(content.classList.contains('open')) renderDrilldown(); }
        function renderDrilldown() { const rDiv = document.getElementById('drilldown-roza'); const mDiv = document.getElementById('drilldown-mrenda'); const draw = (user, colorClass) => { let total = 0; const aData = {}; assetList.forEach(a => aData[a.id] = 0); transactions.filter(t => t.user === user).forEach(t => { total += t.amount; aData[t.asset] += t.amount; }); let html = `<p class="text-[10px] font-black uppercase mb-4 flex items-center gap-2"><span class="w-2 h-2 rounded-full ${colorClass}"></span>${user} Portfolio</p>`; assetList.forEach(a => { const val = aData[a.id]; const pct = total > 0 ? (val/total)*100 : 0; if(val > 0) html += `<div class="mb-4"><div class="flex justify-between text-[8px] font-bold uppercase mb-1"><span>${a.id}</span><span class="text-slate-400">${fmtIDR(val)} (${Math.round(pct)}%)</span></div><div class="w-full bg-slate-100 dark:bg-slate-800 h-1 rounded-full"><div class="${colorClass} h-full" style="width:${pct}%"></div></div></div>`; }); return html; }; rDiv.innerHTML = draw('Roza', 'bg-indigo-600'); mDiv.innerHTML = draw('Mrenda', 'bg-rose-500'); }
        function updateChart(data) { const ctx = document.getElementById('assetChart').getContext('2d'); if(assetChart) assetChart.destroy(); assetChart = new Chart(ctx, { type: 'doughnut', data: { labels: assetList.map(a => a.id), datasets: [{ data, backgroundColor: assetList.map(a => a.color), borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, color: '#94a3b8', font: { size: 10, weight: 'bold' } } } } } }); }
        document.getElementById('wealth-form').onsubmit = (e) => { e.preventDefault(); const amt = parseNum(document.getElementById('in-amount-display').value); const date = document.getElementById('in-date').value; const note = document.getElementById('in-note').value || '-'; if(currentMode === 'transfer') { const bal = transactions.filter(t => t.user === selectedUser && t.asset === selectedAsset).reduce((a,b) => a + b.amount, 0); if(amt > bal) return showToast("Saldo tidak cukup!"); const tid = Date.now(); transactions.push({ id: tid, date, user: selectedUser, asset: selectedAsset, amount: -amt, note: `[Pindah] Ke ${selectedAssetDest}` }); transactions.push({ id: tid+1, date, user: selectedUser, asset: selectedAssetDest, amount: amt, note: `[Pindah] Dari ${selectedAsset}` }); } else { if(editId) { const idx = transactions.findIndex(t => t.id === editId); transactions[idx] = { id: editId, date, user: selectedUser, asset: selectedAsset, amount: amt, note }; editId = null; } else transactions.push({ id: Date.now(), date, user: selectedUser, asset: selectedAsset, amount: amt, note }); } save(); cancelEdit(); showToast("Berhasil!"); };
        function editTx(id) { const t = transactions.find(x => x.id === id); editId = id; setMode('save'); selectUser(t.user); selectedAsset = t.asset; initTiles(); document.getElementById('in-date').value = t.date; document.getElementById('in-amount-display').value = fmtNum(t.amount); document.getElementById('in-note').value = t.note; document.getElementById('btn-submit').innerText = "Update"; document.getElementById('btn-cancel-edit').classList.remove('hidden'); document.getElementById('input-section').scrollIntoView({ behavior: 'smooth' }); }
        function cancelEdit() { editId = null; document.getElementById('wealth-form').reset(); document.getElementById('in-date').valueAsDate = new Date(); document.getElementById('btn-submit').innerText = "Simpan Transaksi"; document.getElementById('btn-cancel-edit').classList.add('hidden'); setMode('save'); }
        function togglePrivacy() { isPrivate = !isPrivate; render(); }
        function exportJSON() { const blob = new Blob([JSON.stringify({ transactions, returns, yearlyGoal, selfReward, msThresholds })], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup.json`; a.click(); }
        function importJSON(i) { const r = new FileReader(); r.onload = (e) => { const d = JSON.parse(e.target.result); transactions = d.transactions || []; returns = d.returns || { "Emas":0, "Reksadana":0, "Obligasi FR":0, "Saham":0, "Deposito":0 }; yearlyGoal = d.yearlyGoal || 100000000; selfReward = d.selfReward || ""; msThresholds = d.msThresholds || { foundation: 10000000, silver: 50000000, legend: 100000000 }; save(); }; r.readAsText(i.files[0]); }
        async function downloadPDF() { const opt = { margin: 10, filename: 'Report.pdf', html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } }; html2pdf().set(opt).from(document.getElementById('content-to-export')).save(); }
        function confirmDelete(id) { openModal("Hapus?", "Yakin hapus data?", () => { transactions = transactions.filter(t => t.id !== id); save(); }); }
        function confirmWipeAll() { openModal("Reset Seluruh Data?", "Semua data akan dihapus permanen.", () => { transactions = []; returns = { "Emas":0, "Reksadana":0, "Obligasi FR":0, "Saham":0, "Deposito":0 }; yearlyGoal = 100000000; selfReward = ""; save(); }); }
        function openModal(t, m, c) { document.getElementById('modal-title').innerText=t; document.getElementById('modal-message').innerText=m; document.getElementById('custom-modal').classList.remove('hidden'); pendingAction=c; }
        function closeModal() { document.getElementById('custom-modal').classList.add('hidden'); }
        document.getElementById('modal-confirm-btn').onclick = () => { if(pendingAction) pendingAction(); closeModal(); };
        document.getElementById('in-amount-display').oninput = (e) => e.target.value = fmtNum(e.target.value);
        window.onload = () => { if (localStorage.getItem('os_theme') === 'dark') toggleDarkMode(); initTiles(); selectUser('Roza'); document.getElementById('in-date').valueAsDate = new Date(); render(); };
    </script>
</body>
</html>
